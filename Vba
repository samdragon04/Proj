Sub Button1_Click()
    Dim filename As Variant
    Dim ws As Worksheet
    Dim rng As Range
    Dim cell As Range
    Dim dataTypes() As Variant
    Dim i As Integer, j As Integer
    Dim highestValue As Integer
    Dim currentValue As Integer

    ' Open the file dialog
    filename = Application.GetOpenFilename(FileFilter:="CSV Files, *.csv", Title:="Select a CSV file", MultiSelect:=False)

    If filename <> False Then
        ' Create a new sheet
        Set ws = ThisWorkbook.Sheets.Add

        ' Import the CSV file
        With ws.QueryTables.Add(Connection:="TEXT;" & filename, Destination:=ws.Range("A1"))
            .TextFilePlatform = 932 ' Adjust this for encoding. 932 is for Shift_JIS.
            .TextFileStartRow = 1
            .TextFileParseType = xlDelimited
            .TextFileTextQualifier = xlTextQualifierDoubleQuote
            .TextFileConsecutiveDelimiter = False
            .TextFileTabDelimiter = False
            .TextFileSemicolonDelimiter = False
            .TextFileCommaDelimiter = True
            .TextFileSpaceDelimiter = False
            .TextFileTrailingMinusNumbers = True

            ' Set the data type array for the AD column to text
            Dim lastColumn As Integer
            lastColumn = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column
            ReDim dataTypes(1 To lastColumn)

            For i = 1 To lastColumn
                If i = 30 Then ' 30 corresponds to column AD
                    dataTypes(i) = 2 ' Treat as text
                Else
                    dataTypes(i) = 1 ' General
                End If
            Next i

            .TextFileColumnDataTypes = dataTypes
            .Refresh BackgroundQuery:=False
        End With

        ' Scan columns C to G for the highest "E0x" value
        Set rng = ws.Range("C2:G" & ws.Cells(ws.Rows.Count, "C").End(xlUp).Row)
        highestValue = 0
        For Each cell In rng
            If Left(cell.Value, 2) = "E0" Then
                currentValue = Val(Mid(cell.Value, 3, 1))
                If currentValue > highestValue Then
                    highestValue = currentValue
                End If
            End If
        Next cell

        ' Gray out preceding values in the range
        For Each cell In rng
            For j = 1 To highestValue - 1
                If Left(cell.Value, 3) = "E0" & j Then
                    cell.Font.Color = RGB(128, 128, 128)
                End If
            Next j
        Next cell
    End If
End Sub
